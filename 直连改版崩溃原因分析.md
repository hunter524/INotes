# 直连改版崩溃原因分析

## 发现崩溃/处理

2020-10-09:
09:00 开始发布 2.7.4 版本进入应用市场
15:11 经吕国辉提醒线上崩溃监测平台开始出现几十次的崩溃次数告警邮件.开始着手分析崩溃日志确定崩溃原因.
16:00 根据日志和代码分析,确定复现条件为老版本用户曾经删除了已经同步成功的股票账户后升级到2.7.4 打开应用就会崩溃.
16:44 确定先使用最简单的修改方法,修复崩溃紧急上线.由于应用在启动之初便崩溃,分析无法使用热修复修复该问题.完成代码修改,提交测试验收.
20:38 测试完成测试验收,准备提交版本发布.

2020-10-10:

10:00 2.7.5版本通过应用市场观察,这个时间应用市场开始上线
15:40 左右崩溃告警邮件基本开始停止频繁告警

初步统计 10-09(周五) 崩溃 1935次,10-10(周六) 崩溃 1209 次,10-11(周日)崩溃 38次,10-12(周一)崩溃 65 次.按照崩溃平均崩溃四次会触发崩溃恢复逻辑,影响 750 人左右.

## 崩溃原因/修复

### 现状

股票同步成功之后数据分为两部分,一部分为用户的资产数据,帐号数据(存储在数据库中),另外一部分是直连/主站同步成功之后返回的 Token 数据,用于下次同步时不需要使用帐号密码进行登录,直接可以使用 Token 进行同步.(存储在本地的另外一个文件中).Token 的管理没有和本地帐号的删除进行绑定,当帐号删除时数据库中的数据会被删除,但是存储在本地的 Token 数据不会同步进行删除. 本地 Token 管理类中存在 Token 删除逻辑,但是没有任何地方使用.(从代码库历史代码跟踪,该方法从2018-01-04 重构独立委托,即存在删除方法,但是该方法无处调用的情况)

### 直连改动

直连模块登录/同步需要提供委托帐号信息,但是该帐号信息不存在于本地存储的 Token 文件中,但是存在于本地的资产数据的数据库中,因此为了保证更改直连不会对线上用户造成影响所以在升级之后恢复本地Token信息时同时去数据库中查询对应帐号的委托帐号信息,填充到 Token 中,保证后面的自动同步手动同步切换成直连可以直接执行.

### 崩溃直接原因

用户删除已经同步成功的帐号时未删除 Token 文件中对应的帐号信息,只删除了本地数据库中的资产信息.因此 Token 中的帐号信息多于数据库中的帐号信息,当恢复token 时去查数据库中的信息时未获取到,又没有判空因此导致了 NPE. 同时该任务是直接创建线程直接执行的,根据 Android 的实现机制如果子线程自己存在未捕获的异常,则异常向父线程传递,根线程的异常处理器执行上报异常,杀死当前应用的操作.

### 导致崩溃的主要原因

- 可能是当时的设计存在缺陷,也有可能是当时出于某种限制条件设计成了 Token 和 账号资产数据分开存储,但是可能又由于种种原因在实现时没有做到 Token 和 帐号资产数据同步删除/更新.
  
- 直连更改该部分代码时未仔细阅读这一块的实现逻辑,只在找到的切入点做了想当然的改动.

### 崩溃修复

崩溃修复本着最少改动尽快上线的原则,因此只在读取数据库是添加了一次判空操作,数据库读取为空则将该帐号对应的 Token 置为过期状态.

## 后期优化点

### 数据一致性

对于相互关联的数据要做到集中管理,从而保证相互关联的数据做到增删改的一致性.(首先对 Token和股票资产数据做到一致性)

### NPE 保护/Nullable

对于类似读取数据库等操作可能返回为 null 的情形要求在方法返回值上添加注解 javax.annotation.Nullable

使用 kotlin 编写新的业务代码,使用 ?. 安全的调用 null 的方法/属性

引入 guava 库/jdk 1.8 的 java.util.Optional,对于可能返回 null 的方法强制返回 Optional,从而强制提醒调用者进行判空操作.

### 不要直接 new Thread

使用线程池, rxjava 执行异步任务.(但是在一定程度上会隐藏问题,就该问题而言会导致该部分用户切换成直连无法同步成功)

### 热更新提前/提高优先级

和手炒热更新组件组对接,添加崩溃之后,应用启动的第一时间进行同步热更新检查和热更新操作.
